<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>食品成本计算器</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;-webkit-touch-callout:none}
:root{
  --bg:#0a0a0a;--card:#1c1c1e;--card2:#2c2c2e;
  --primary:#0a84ff;--green:#30d158;--orange:#ff9f0a;--red:#ff453a;
  --text:#f5f5f7;--text2:#98989f;--text3:#636366;
  --border:#38383a;
}
html,body{
  font-family:-apple-system,BlinkMacSystemFont,"SF Pro Display","SF Pro Text",sans-serif;
  background:var(--bg);color:var(--text);
  height:100%;overflow:hidden;
  position:fixed;width:100%;
}
#app{display:flex;flex-direction:column;height:100%;}

/* ===== Header ===== */
.header{
  padding:8px 16px;padding-top:max(8px,env(safe-area-inset-top));
  display:flex;align-items:center;justify-content:space-between;
  background:rgba(10,10,10,0.85);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);
  border-bottom:0.5px solid var(--border);flex-shrink:0;z-index:10;
}
.header h1{font-size:17px;font-weight:600;letter-spacing:-0.2px;}
.hdr-btns{display:flex;gap:4px;}
.hdr-btn{
  background:none;border:none;color:var(--primary);font-size:14px;
  padding:6px 10px;cursor:pointer;font-weight:500;border-radius:8px;
}
.hdr-btn:active{background:rgba(10,132,255,0.15);}
.hdr-btn.danger{color:var(--red);}

/* ===== Total ===== */
.total-section{
  padding:16px 20px;flex-shrink:0;
  background:linear-gradient(135deg,#1a1a2e 0%,#16213e 100%);
  border-bottom:0.5px solid var(--border);
}
.total-label{font-size:13px;color:var(--text2);margin-bottom:4px;font-weight:500;}
.total-amount{font-size:36px;font-weight:700;letter-spacing:-1px;font-variant-numeric:tabular-nums;}

/* ===== Labels tray ===== */
.labels-tray{
  padding:10px 16px;flex-shrink:0;
  border-bottom:0.5px solid var(--border);
  background:var(--bg);
}
.labels-tray-title{font-size:11px;color:var(--text3);font-weight:600;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:8px;}
.labels-scroll{display:flex;gap:8px;overflow-x:auto;-webkit-overflow-scrolling:touch;padding-bottom:4px;}
.labels-scroll::-webkit-scrollbar{display:none;}
.tag{
  flex-shrink:0;padding:6px 14px;border-radius:20px;font-size:13px;font-weight:500;
  cursor:grab;-webkit-user-select:none;user-select:none;
  border:1.5px solid var(--border);color:var(--text);background:var(--card);
  transition:transform 0.15s,box-shadow 0.15s;position:relative;
}
.tag:active{transform:scale(1.05);}
.tag.dragging{
  opacity:0.9;transform:scale(1.1);
  box-shadow:0 8px 32px rgba(0,0,0,0.5);z-index:999;
}
.tag.c0{border-color:#ff6b6b;color:#ff6b6b;background:rgba(255,107,107,0.1);}
.tag.c1{border-color:#ffa94d;color:#ffa94d;background:rgba(255,169,77,0.1);}
.tag.c2{border-color:#ffd43b;color:#ffd43b;background:rgba(255,212,59,0.1);}
.tag.c3{border-color:#69db7c;color:#69db7c;background:rgba(105,219,124,0.1);}
.tag.c4{border-color:#74c0fc;color:#74c0fc;background:rgba(116,192,252,0.1);}
.tag.c5{border-color:#b197fc;color:#b197fc;background:rgba(177,151,252,0.1);}
.tag.c6{border-color:#e599f7;color:#e599f7;background:rgba(229,153,247,0.1);}
.tag.c7{border-color:#fcc2d7;color:#fcc2d7;background:rgba(252,194,215,0.1);}
.tag-add{border-style:dashed;color:var(--text3);border-color:var(--text3);}

/* ===== Expression rows area ===== */
.rows-area{flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;padding:8px 12px;}
.row{
  background:var(--card);border-radius:14px;margin-bottom:8px;
  padding:10px 12px;
  display:flex;align-items:center;gap:4px;flex-wrap:wrap;
  min-height:52px;position:relative;
}
.row .subtotal{
  margin-left:auto;font-size:15px;font-weight:600;color:var(--green);
  font-variant-numeric:tabular-nums;white-space:nowrap;flex-shrink:0;
  padding-left:8px;
}
.row .del-row{
  background:none;border:none;color:var(--text3);font-size:18px;
  padding:2px 6px;cursor:pointer;flex-shrink:0;
}
.row .del-row:active{color:var(--red);}

/* Tokens inside a row */
.token{display:inline-flex;flex-direction:column;align-items:center;position:relative;margin:2px;}
.token-num{
  background:var(--card2);border-radius:8px;padding:6px 10px;
  font-size:17px;font-weight:500;font-variant-numeric:tabular-nums;
  min-width:36px;text-align:center;
  border:2px solid transparent;transition:border-color 0.2s,background 0.2s;
  position:relative;
}
.token-num.drop-target{border-color:var(--primary);background:rgba(10,132,255,0.12);}
.token-label{
  font-size:10px;font-weight:600;letter-spacing:0.3px;
  margin-top:3px;max-width:80px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;
  padding:1px 6px;border-radius:4px;
}
.token-label.empty{color:var(--text3);font-weight:400;}
.token-op{
  font-size:18px;font-weight:600;color:var(--text2);
  padding:4px 2px;min-width:20px;text-align:center;
}

/* Add row button */
.add-row{
  border:2px dashed var(--border);border-radius:14px;
  background:none;color:var(--text3);font-size:14px;
  padding:12px;width:100%;cursor:pointer;margin-bottom:8px;
}
.add-row:active{background:var(--card);}

/* ===== Numpad ===== */
.numpad{
  flex-shrink:0;
  background:#1c1c1e;
  padding:6px;padding-bottom:max(6px,env(safe-area-inset-bottom));
  border-top:0.5px solid var(--border);
}
.np-row{display:flex;gap:6px;margin-bottom:6px;}
.np-row:last-child{margin-bottom:0;}
.nk{
  flex:1;border:none;border-radius:8px;
  padding:14px 0;font-size:20px;font-weight:400;
  cursor:pointer;text-align:center;
  -webkit-user-select:none;user-select:none;
  color:var(--text);background:var(--card2);
  transition:background 0.1s;
}
.nk:active{background:#4a4a4e;}
.nk.op{background:#4a4a4e;color:var(--orange);font-weight:600;}
.nk.op:active{background:#5a5a5e;}
.nk.fn{background:var(--card2);color:var(--text2);font-size:15px;font-weight:500;}
.nk.fn:active{background:#4a4a4e;}
.nk.enter{background:var(--primary);color:#fff;font-weight:600;font-size:16px;}
.nk.enter:active{background:#0070e0;}
.nk.wide2{flex:2;}
.nk.backspace{font-size:18px;}

/* ===== Floating drag ghost ===== */
.drag-ghost{
  position:fixed;pointer-events:none;z-index:9999;
  padding:6px 14px;border-radius:20px;font-size:13px;font-weight:600;
  box-shadow:0 12px 40px rgba(0,0,0,0.6);
  transform:translate(-50%,-50%) scale(1.15);
  opacity:0.95;
}

/* ===== Label picker (tap on number) ===== */
.picker-overlay{
  display:none;position:fixed;inset:0;z-index:200;
  background:rgba(0,0,0,0.5);
}
.picker-overlay.show{display:flex;align-items:flex-end;justify-content:center;}
.picker{
  background:var(--card);border-radius:16px 16px 0 0;
  width:100%;max-width:500px;
  padding:16px;padding-bottom:max(16px,env(safe-area-inset-bottom));
}
.picker h3{font-size:15px;font-weight:600;text-align:center;margin-bottom:12px;color:var(--text);}
.picker-tags{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:12px;}
.picker-tag{
  padding:8px 16px;border-radius:20px;font-size:14px;font-weight:500;
  cursor:pointer;border:1.5px solid var(--border);color:var(--text);background:var(--card2);
}
.picker-tag:active{opacity:0.7;}
.picker-input-row{display:flex;gap:8px;margin-bottom:8px;}
.picker-input{
  flex:1;background:var(--card2);border:1px solid var(--border);border-radius:10px;
  padding:10px 14px;font-size:15px;color:var(--text);outline:none;
}
.picker-input:focus{border-color:var(--primary);}
.picker-ok{
  background:var(--primary);color:#fff;border:none;border-radius:10px;
  padding:10px 18px;font-size:15px;font-weight:500;cursor:pointer;
}
.picker-clear{
  background:none;border:1.5px solid var(--border);color:var(--text2);
  border-radius:10px;padding:10px 18px;font-size:15px;cursor:pointer;
  font-weight:500;
}
.picker-clear:active{background:var(--card2);}
.picker-bottom{display:flex;gap:8px;}

/* ===== Save modal ===== */
.modal-overlay{
  display:none;position:fixed;inset:0;z-index:200;
  background:rgba(0,0,0,0.5);
}
.modal-overlay.show{display:flex;align-items:center;justify-content:center;}
.modal{
  background:var(--card);border-radius:16px;width:90%;max-width:400px;padding:20px;
}
.modal h3{font-size:17px;font-weight:600;margin-bottom:16px;text-align:center;}
.modal-list{max-height:250px;overflow-y:auto;margin-bottom:12px;}
.modal-item{
  display:flex;align-items:center;justify-content:space-between;
  padding:12px 4px;border-bottom:0.5px solid var(--border);cursor:pointer;
}
.modal-item:active{opacity:0.6;}
.modal-item .mi-name{font-size:15px;font-weight:500;}
.modal-item .mi-meta{font-size:12px;color:var(--text2);}
.modal-item .mi-del{background:none;border:none;color:var(--text3);font-size:16px;cursor:pointer;padding:4px 8px;}
.modal-input{
  width:100%;background:var(--card2);border:1px solid var(--border);border-radius:10px;
  padding:10px 14px;font-size:15px;color:var(--text);outline:none;margin-bottom:12px;
}
.modal-input:focus{border-color:var(--primary);}
.modal-btns{display:flex;gap:8px;}
.modal-btns button{
  flex:1;border:none;border-radius:10px;padding:12px;font-size:15px;cursor:pointer;font-weight:500;
}
.mbtn-cancel{background:var(--card2);color:var(--text);}
.mbtn-ok{background:var(--primary);color:#fff;}
</style>
</head>
<body>
<div id="app">

  <!-- Header -->
  <div class="header">
    <h1>食品成本计算器</h1>
    <div class="hdr-btns">
      <button class="hdr-btn" id="btnSave">存档</button>
      <button class="hdr-btn danger" id="btnClear">清空</button>
    </div>
  </div>

  <!-- Total -->
  <div class="total-section">
    <div class="total-label">合计金额</div>
    <div class="total-amount" id="totalAmount">¥0.00</div>
  </div>

  <!-- Labels tray (draggable) -->
  <div class="labels-tray">
    <div class="labels-tray-title">拖拽标签到数字上</div>
    <div class="labels-scroll" id="labelsScroll"></div>
  </div>

  <!-- Expression rows -->
  <div class="rows-area" id="rowsArea"></div>

  <!-- Numpad -->
  <div class="numpad" id="numpad">
    <div class="np-row">
      <button class="nk fn" data-v="label">标签</button>
      <button class="nk fn" data-v="newrow">换行</button>
      <button class="nk backspace fn" data-v="del">⌫</button>
      <button class="nk op" data-v="÷">÷</button>
    </div>
    <div class="np-row">
      <button class="nk" data-v="7">7</button>
      <button class="nk" data-v="8">8</button>
      <button class="nk" data-v="9">9</button>
      <button class="nk op" data-v="×">×</button>
    </div>
    <div class="np-row">
      <button class="nk" data-v="4">4</button>
      <button class="nk" data-v="5">5</button>
      <button class="nk" data-v="6">6</button>
      <button class="nk op" data-v="-">-</button>
    </div>
    <div class="np-row">
      <button class="nk" data-v="1">1</button>
      <button class="nk" data-v="2">2</button>
      <button class="nk" data-v="3">3</button>
      <button class="nk op" data-v="+">+</button>
    </div>
    <div class="np-row">
      <button class="nk wide2" data-v="0">0</button>
      <button class="nk" data-v=".">.</button>
      <button class="nk enter" data-v="=">完成</button>
    </div>
  </div>
</div>

<!-- Label picker -->
<div class="picker-overlay" id="pickerOverlay">
  <div class="picker">
    <h3>给数字贴标签</h3>
    <div class="picker-tags" id="pickerTags"></div>
    <div class="picker-input-row">
      <input class="picker-input" id="pickerInput" placeholder="自定义标签">
      <button class="picker-ok" id="pickerOk">确定</button>
    </div>
    <div class="picker-bottom">
      <button class="picker-clear" id="pickerClear">清除标签</button>
    </div>
  </div>
</div>

<!-- Save/Load modal -->
<div class="modal-overlay" id="modalOverlay">
  <div class="modal">
    <h3>存档 / 读档</h3>
    <div class="modal-list" id="modalList"></div>
    <input class="modal-input" id="modalInput" placeholder="输入方案名称">
    <div class="modal-btns">
      <button class="mbtn-cancel" id="modalCancel">取消</button>
      <button class="mbtn-ok" id="modalSave">保存当前</button>
    </div>
  </div>
</div>

<!-- Drag ghost -->
<div class="drag-ghost" id="dragGhost" style="display:none"></div>

<script>
// ====== Data ======
const TAG_COLORS = ['c0','c1','c2','c3','c4','c5','c6','c7'];
const DEFAULT_LABELS = ['面粉','糖','盐','油','奶粉','鸡蛋','黄油','酵母','添加剂','包装袋','纸箱','标签贴','人工','运费','水电','租金'];
let customLabels = load('fc_labels2', []);
let rows = load('fc_rows2', []);  // [{tokens:[{type:'num',value:'',label:''},{type:'op',value:'+'},...]}]
let activeRow = 0;
let activeTokenIdx = -1; // which num token is "selected" for keyboard input
let pickerTarget = null; // {row, tokenIdx}

function load(k, def) { try { const d = localStorage.getItem(k); return d ? JSON.parse(d) : def; } catch { return def; } }
function save(k, v) { localStorage.setItem(k, JSON.stringify(v)); }
function allLabels() { return [...new Set([...DEFAULT_LABELS, ...customLabels])]; }
function tagColor(label) { const labels = allLabels(); const i = labels.indexOf(label); return TAG_COLORS[((i >= 0 ? i : label.length) % TAG_COLORS.length)]; }

// ====== Init ======
if (rows.length === 0) rows.push(makeRow());
renderLabels();
renderRows();
recalc();

function makeRow() { return { tokens: [{ type: 'num', value: '', label: '' }] }; }

// ====== Render labels tray ======
function renderLabels() {
  const el = document.getElementById('labelsScroll');
  const labels = allLabels();
  el.innerHTML = labels.map((l, i) =>
    `<div class="tag ${tagColor(l)}" data-label="${esc(l)}">${esc(l)}</div>`
  ).join('') + `<div class="tag tag-add" id="tagAdd">+ 添加</div>`;
  // Bind drag events
  el.querySelectorAll('.tag:not(.tag-add)').forEach(bindTagDrag);
  document.getElementById('tagAdd').addEventListener('click', promptNewLabel);
}

function promptNewLabel() {
  const name = prompt('输入新标签名称');
  if (!name || !name.trim()) return;
  const t = name.trim();
  if (!customLabels.includes(t) && !DEFAULT_LABELS.includes(t)) {
    customLabels.push(t);
    save('fc_labels2', customLabels);
  }
  renderLabels();
}

// ====== Render rows ======
function renderRows() {
  const area = document.getElementById('rowsArea');
  area.innerHTML = rows.map((row, ri) => {
    const tokensHtml = row.tokens.map((tok, ti) => {
      if (tok.type === 'op') {
        return `<div class="token"><div class="token-op">${esc(tok.value)}</div></div>`;
      }
      // num token
      const isActive = (ri === activeRow && ti === activeTokenIdx);
      const labelHtml = tok.label
        ? `<div class="token-label" style="color:${labelColor(tok.label)}">${esc(tok.label)}</div>`
        : `<div class="token-label empty">点击贴标签</div>`;
      return `<div class="token" data-ri="${ri}" data-ti="${ti}">
        <div class="token-num${isActive ? ' drop-target' : ''}" data-ri="${ri}" data-ti="${ti}">${tok.value || '<span style="color:var(--text3)">_</span>'}</div>
        ${labelHtml}
      </div>`;
    }).join('');

    const sub = evalRow(row);
    const subText = sub !== null ? '¥' + sub.toFixed(2) : '';

    return `<div class="row${ri === activeRow ? '' : ''}" data-ri="${ri}">
      ${tokensHtml}
      <span class="subtotal">${subText}</span>
      <button class="del-row" data-ri="${ri}">×</button>
    </div>`;
  }).join('') + `<button class="add-row" id="addRowBtn">+ 添加一行</button>`;

  // Bind events
  area.querySelectorAll('.token-num').forEach(el => {
    el.addEventListener('click', onNumTap);
  });
  area.querySelectorAll('.token-label').forEach(el => {
    el.addEventListener('click', onLabelTap);
  });
  area.querySelectorAll('.del-row').forEach(el => {
    el.addEventListener('click', e => {
      e.stopPropagation();
      const ri = +el.dataset.ri;
      if (rows.length <= 1) { rows = [makeRow()]; activeRow = 0; activeTokenIdx = 0; }
      else { rows.splice(ri, 1); if (activeRow >= rows.length) activeRow = rows.length - 1; activeTokenIdx = getLastNumIdx(rows[activeRow]); }
      persist(); renderRows(); recalc();
    });
  });
  document.getElementById('addRowBtn').addEventListener('click', () => {
    rows.push(makeRow());
    activeRow = rows.length - 1;
    activeTokenIdx = 0;
    persist(); renderRows(); recalc();
  });
}

function labelColor(label) {
  const cls = tagColor(label);
  const map = { c0:'#ff6b6b',c1:'#ffa94d',c2:'#ffd43b',c3:'#69db7c',c4:'#74c0fc',c5:'#b197fc',c6:'#e599f7',c7:'#fcc2d7' };
  return map[cls] || '#98989f';
}

function getLastNumIdx(row) {
  for (let i = row.tokens.length - 1; i >= 0; i--) {
    if (row.tokens[i].type === 'num') return i;
  }
  return 0;
}

function esc(s) { return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

// ====== Tap handlers ======
function onNumTap(e) {
  const ri = +e.currentTarget.dataset.ri;
  const ti = +e.currentTarget.dataset.ti;
  activeRow = ri;
  activeTokenIdx = ti;
  renderRows();
}

function onLabelTap(e) {
  const token = e.currentTarget.closest('.token');
  if (!token) return;
  const ri = +token.dataset.ri;
  const ti = +token.dataset.ti;
  openPicker(ri, ti);
}

// ====== Eval ======
function evalRow(row) {
  let expr = '';
  for (const tok of row.tokens) {
    if (tok.type === 'op') {
      const v = tok.value;
      if (v === '×') expr += '*';
      else if (v === '÷') expr += '/';
      else expr += v;
    } else {
      if (!tok.value && tok.value !== '0') return null;
      expr += tok.value;
    }
  }
  if (!expr.trim()) return null;
  try {
    const r = Function('"use strict"; return (' + expr + ')')();
    if (typeof r === 'number' && isFinite(r)) return r;
    return null;
  } catch { return null; }
}

function recalc() {
  let total = 0;
  rows.forEach(r => { const v = evalRow(r); if (v !== null) total += v; });
  document.getElementById('totalAmount').textContent = '¥' + total.toFixed(2);
}

function persist() { save('fc_rows2', rows); }

// ====== Numpad ======
document.getElementById('numpad').addEventListener('click', e => {
  const btn = e.target.closest('.nk');
  if (!btn) return;
  e.preventDefault();
  const v = btn.dataset.v;
  const row = rows[activeRow];
  if (!row) return;

  if (v === '=') {
    // "done" - nothing special, just deselect
    activeTokenIdx = -1;
    renderRows(); recalc();
    return;
  }

  if (v === 'newrow') {
    rows.push(makeRow());
    activeRow = rows.length - 1;
    activeTokenIdx = 0;
    persist(); renderRows(); recalc();
    // Scroll to bottom
    document.getElementById('rowsArea').scrollTop = 99999;
    return;
  }

  if (v === 'label') {
    if (activeTokenIdx >= 0 && row.tokens[activeTokenIdx] && row.tokens[activeTokenIdx].type === 'num') {
      openPicker(activeRow, activeTokenIdx);
    }
    return;
  }

  if (v === 'del') {
    if (activeTokenIdx < 0) activeTokenIdx = getLastNumIdx(row);
    const tok = row.tokens[activeTokenIdx];
    if (!tok || tok.type !== 'num') return;
    if (tok.value.length > 0) {
      tok.value = tok.value.slice(0, -1);
    } else {
      // Remove this num and preceding op
      if (activeTokenIdx > 0) {
        row.tokens.splice(activeTokenIdx - 1, 2); // remove op + num
        activeTokenIdx = Math.max(0, activeTokenIdx - 2);
        if (row.tokens.length === 0) row.tokens.push({ type: 'num', value: '', label: '' });
        if (activeTokenIdx >= row.tokens.length) activeTokenIdx = getLastNumIdx(row);
      }
    }
    persist(); renderRows(); recalc();
    return;
  }

  // Operators: create new num token
  if (['+', '-', '×', '÷'].includes(v)) {
    // Ensure current num has value
    if (activeTokenIdx < 0) activeTokenIdx = getLastNumIdx(row);
    const curTok = row.tokens[activeTokenIdx];
    if (!curTok || (curTok.type === 'num' && !curTok.value)) return; // don't add op after empty

    row.tokens.push({ type: 'op', value: v });
    row.tokens.push({ type: 'num', value: '', label: '' });
    activeTokenIdx = row.tokens.length - 1;
    persist(); renderRows(); recalc();
    return;
  }

  // Number/dot input
  if (activeTokenIdx < 0) activeTokenIdx = getLastNumIdx(row);
  const tok = row.tokens[activeTokenIdx];
  if (!tok || tok.type !== 'num') return;

  if (v === '.' && tok.value.includes('.')) return; // prevent double dot
  tok.value += v;
  persist(); renderRows(); recalc();
});

// ====== Drag & Drop (touch) ======
let dragLabel = '';
let dragActive = false;
const ghost = document.getElementById('dragGhost');

function bindTagDrag(el) {
  el.addEventListener('touchstart', onDragStart, { passive: false });
  el.addEventListener('touchmove', onDragMove, { passive: false });
  el.addEventListener('touchend', onDragEnd);
}

function onDragStart(e) {
  const label = e.currentTarget.dataset.label;
  if (!label) return;
  dragLabel = label;
  dragActive = false;
  // Prepare ghost
  ghost.textContent = label;
  ghost.className = 'drag-ghost ' + tagColor(label);
  ghost.style.background = getComputedStyle(e.currentTarget).background;
  ghost.style.color = getComputedStyle(e.currentTarget).color;
  ghost.style.borderColor = getComputedStyle(e.currentTarget).borderColor;
  ghost.style.border = '1.5px solid ' + getComputedStyle(e.currentTarget).borderColor;
}

function onDragMove(e) {
  e.preventDefault();
  const touch = e.touches[0];
  if (!dragLabel) return;
  if (!dragActive) {
    dragActive = true;
    ghost.style.display = 'block';
    e.currentTarget.classList.add('dragging');
  }
  ghost.style.left = touch.clientX + 'px';
  ghost.style.top = touch.clientY + 'px';

  // Highlight drop targets
  document.querySelectorAll('.token-num').forEach(el => {
    const rect = el.getBoundingClientRect();
    if (touch.clientX >= rect.left && touch.clientX <= rect.right &&
        touch.clientY >= rect.top && touch.clientY <= rect.bottom) {
      el.classList.add('drop-target');
    } else {
      if (+el.dataset.ri !== activeRow || +el.dataset.ti !== activeTokenIdx)
        el.classList.remove('drop-target');
    }
  });
}

function onDragEnd(e) {
  ghost.style.display = 'none';
  document.querySelectorAll('.tag.dragging').forEach(el => el.classList.remove('dragging'));

  if (!dragActive || !dragLabel) { dragLabel = ''; return; }

  const touch = e.changedTouches[0];
  let dropped = false;
  document.querySelectorAll('.token-num').forEach(el => {
    const rect = el.getBoundingClientRect();
    if (touch.clientX >= rect.left && touch.clientX <= rect.right &&
        touch.clientY >= rect.top && touch.clientY <= rect.bottom) {
      const ri = +el.dataset.ri;
      const ti = +el.dataset.ti;
      if (rows[ri] && rows[ri].tokens[ti] && rows[ri].tokens[ti].type === 'num') {
        rows[ri].tokens[ti].label = dragLabel;
        dropped = true;
      }
    }
    el.classList.remove('drop-target');
  });

  if (dropped) { persist(); renderRows(); recalc(); }
  dragLabel = '';
  dragActive = false;
}

// ====== Label Picker (tap) ======
function openPicker(ri, ti) {
  pickerTarget = { row: ri, tokenIdx: ti };
  const labels = allLabels();
  const tagsEl = document.getElementById('pickerTags');
  tagsEl.innerHTML = labels.map(l =>
    `<div class="picker-tag ${tagColor(l)}" data-label="${esc(l)}" style="border-color:${labelColor(l)};color:${labelColor(l)};background:rgba(255,255,255,0.05)">${esc(l)}</div>`
  ).join('');
  tagsEl.querySelectorAll('.picker-tag').forEach(el => {
    el.addEventListener('click', () => {
      applyPickerLabel(el.dataset.label);
    });
  });
  document.getElementById('pickerInput').value = '';
  document.getElementById('pickerOverlay').classList.add('show');
}

function applyPickerLabel(label) {
  if (!pickerTarget) return;
  const { row, tokenIdx } = pickerTarget;
  if (rows[row] && rows[row].tokens[tokenIdx]) {
    rows[row].tokens[tokenIdx].label = label;
    // Also save custom label
    if (label && !customLabels.includes(label) && !DEFAULT_LABELS.includes(label)) {
      customLabels.push(label);
      save('fc_labels2', customLabels);
      renderLabels();
    }
    persist(); renderRows(); recalc();
  }
  document.getElementById('pickerOverlay').classList.remove('show');
  pickerTarget = null;
}

document.getElementById('pickerOk').addEventListener('click', () => {
  const v = document.getElementById('pickerInput').value.trim();
  if (v) applyPickerLabel(v);
});

document.getElementById('pickerClear').addEventListener('click', () => {
  if (!pickerTarget) return;
  const { row, tokenIdx } = pickerTarget;
  if (rows[row] && rows[row].tokens[tokenIdx]) {
    rows[row].tokens[tokenIdx].label = '';
    persist(); renderRows(); recalc();
  }
  document.getElementById('pickerOverlay').classList.remove('show');
  pickerTarget = null;
});

document.getElementById('pickerOverlay').addEventListener('click', e => {
  if (e.target === e.currentTarget) {
    document.getElementById('pickerOverlay').classList.remove('show');
    pickerTarget = null;
  }
});

// ====== Save/Load ======
document.getElementById('btnSave').addEventListener('click', () => {
  renderSaveList();
  document.getElementById('modalOverlay').classList.add('show');
});

document.getElementById('modalCancel').addEventListener('click', () => {
  document.getElementById('modalOverlay').classList.remove('show');
});

document.getElementById('modalOverlay').addEventListener('click', e => {
  if (e.target === e.currentTarget) document.getElementById('modalOverlay').classList.remove('show');
});

document.getElementById('modalSave').addEventListener('click', () => {
  const name = document.getElementById('modalInput').value.trim();
  if (!name) { document.getElementById('modalInput').focus(); return; }
  const schemes = load('fc_schemes2', []);
  const now = new Date();
  const date = `${now.getMonth()+1}/${now.getDate()} ${now.getHours()}:${String(now.getMinutes()).padStart(2,'0')}`;
  schemes.unshift({ name, rows: JSON.parse(JSON.stringify(rows)), date });
  save('fc_schemes2', schemes);
  document.getElementById('modalInput').value = '';
  renderSaveList();
});

function renderSaveList() {
  const schemes = load('fc_schemes2', []);
  const el = document.getElementById('modalList');
  if (schemes.length === 0) {
    el.innerHTML = '<div style="text-align:center;color:var(--text3);padding:20px;font-size:14px">暂无存档</div>';
    return;
  }
  el.innerHTML = schemes.map((s, i) => {
    let total = 0;
    s.rows.forEach(r => { const v = evalRow(r); if (v !== null) total += v; });
    return `<div class="modal-item" data-idx="${i}">
      <div><div class="mi-name">${esc(s.name)}</div><div class="mi-meta">${s.rows.length}行 · ¥${total.toFixed(2)} · ${esc(s.date)}</div></div>
      <button class="mi-del" data-idx="${i}">×</button>
    </div>`;
  }).join('');
  el.querySelectorAll('.modal-item').forEach(item => {
    item.addEventListener('click', e => {
      if (e.target.classList.contains('mi-del')) return;
      const idx = +item.dataset.idx;
      const schemes = load('fc_schemes2', []);
      if (schemes[idx]) {
        rows = JSON.parse(JSON.stringify(schemes[idx].rows));
        activeRow = 0; activeTokenIdx = getLastNumIdx(rows[0]);
        persist(); renderRows(); recalc();
      }
      document.getElementById('modalOverlay').classList.remove('show');
    });
  });
  el.querySelectorAll('.mi-del').forEach(btn => {
    btn.addEventListener('click', e => {
      e.stopPropagation();
      const idx = +btn.dataset.idx;
      const schemes = load('fc_schemes2', []);
      schemes.splice(idx, 1);
      save('fc_schemes2', schemes);
      renderSaveList();
    });
  });
}

// ====== Clear ======
document.getElementById('btnClear').addEventListener('click', () => {
  if (confirm('确定清空所有项目？')) {
    rows = [makeRow()];
    activeRow = 0; activeTokenIdx = 0;
    persist(); renderRows(); recalc();
  }
});

// ====== Active row init ======
activeTokenIdx = getLastNumIdx(rows[activeRow]);
renderRows();
</script>
</body>
</html>
